<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard - Hespie Supermarket</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="/css/theme.css">
</head>
<body>
  <%- include('partials/header') %>

  <div class="container py-4">
    <% if (success && success.length) { %>
      <div class="alert alert-success">
        <% success.forEach(msg => { %><p class="mb-0"><%= msg %></p><% }); %>
      </div>
    <% } %>
    <% if (error && error.length) { %>
      <div class="alert alert-danger">
        <% error.forEach(msg => { %><p class="mb-0"><%= msg %></p><% }); %>
      </div>
    <% } %>

    <div class="page-hero mb-4">
      <div class="d-flex flex-wrap justify-content-between align-items-center">
        <div>
          <h2 class="page-title mb-1">Admin Dashboard</h2>
          <p class="page-subtitle mb-0">Overview of orders, revenue, and users.</p>
        </div>
        <div class="floating-actions">
          <a class="btn btn-primary" href="/inventory">Inventory</a>
          <a class="btn btn-secondary" href="/admin/purchases">Receipts</a>
          <a class="btn btn-secondary" href="/admin/users">Users</a>
        </div>
      </div>
    </div>

    <div class="row g-3 mb-4">
      <div class="col-md-4">
        <div class="section-card h-100">
          <p class="text-muted mb-1">Total Orders</p>
          <h3 class="mb-0"><%= totalOrders %></h3>
        </div>
      </div>
      <div class="col-md-4">
        <div class="section-card h-100">
          <p class="text-muted mb-1">Total Revenue</p>
          <h3 class="mb-0">$<%= Number(totalRevenue).toFixed(2) %></h3>
        </div>
      </div>
      <div class="col-md-4">
        <div class="section-card h-100">
          <p class="text-muted mb-1">Users</p>
          <h3 class="mb-0"><%= totalUsers %></h3>
        </div>
      </div>
    </div>

    <div class="section-card mb-3">
      <h5 class="mb-3">Order Status Breakdown</h5>
      <div class="alert alert-info py-2 mb-3">
        Refunds can be processed for PayPal and Stripe orders after the user requests a refund.
      </div>
      <div class="row g-2">
        <% 
          const statusClassMap = {
            'Processing': 'bg-warning text-dark',
            'Packing': 'bg-info text-dark',
            'Ready for Pickup': 'bg-primary',
            'Out for Delivery': 'bg-info text-dark',
            'Completed': 'bg-success',
            'Cancelled': 'bg-secondary',
            'Failed Payment': 'bg-danger',
            'Refund Requested': 'bg-warning text-dark',
            'Refund Rejected': 'bg-secondary',
            'Refunded': 'bg-dark'
          };
          const paymentClassMap = {
            paypal: 'bg-primary',
            stripe: 'bg-dark',
            nets: 'bg-info text-dark',
            cod: 'bg-secondary'
          };
        %>
        <% if (statuses && statuses.length) { %>
          <% statuses.forEach(key => { %>
            <div class="col-6 col-md-3">
              <div class="section-card d-flex justify-content-between align-items-center p-3">
                <span class="text-muted small"><%= key %></span>
                <span class="badge <%= statusClassMap[key] || 'bg-secondary' %>">
                  <%= statusCounts && statusCounts[key] ? statusCounts[key] : 0 %>
                </span>
              </div>
            </div>
          <% }); %>
        <% } else { %>
          <span class="text-muted">No orders yet.</span>
        <% } %>
      </div>
    </div>

    <div class="section-card">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Recent Orders</h5>
      </div>
      <div class="table-responsive">
        <table class="table table-striped align-middle">
          <thead>
            <tr>
              <th>Order #</th>
              <th>User</th>
              <th>Payment</th>
              <th>Date</th>
              <th>Items</th>
              <th>Total</th>
              <th>Status</th>
              <th>Update</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <% if (!orders || orders.length === 0) { %>
              <tr><td colspan="8" class="text-center text-muted">No orders yet.</td></tr>
            <% } else { %>
              <% orders.forEach(o => { 
                const status = o.status || 'Processing';
                const badgeClass = statusClassMap[status] || 'bg-secondary';
                const statusLocked = o.userRole === 'deleted';
              %>
                <tr>
                  <td>#<%= o.id %></td>
                  <td>
                    <div class="fw-semibold"><%= o.username %></div>
                    <div class="text-muted small"><%= o.email %></div>
                  </td>
                  <td>
                    <%
                      const rawPayment = o.paymentMethod || '';
                      const paymentKey = rawPayment.toLowerCase();
                      let paymentLabel = 'N/A';
                      let paymentBadgeClass = 'bg-secondary';
                      if (paymentKey.includes('paypal')) {
                        paymentLabel = 'PayPal';
                        paymentBadgeClass = paymentClassMap.paypal;
                      } else if (paymentKey.includes('stripe')) {
                        paymentLabel = 'Stripe';
                        paymentBadgeClass = paymentClassMap.stripe;
                      } else if (paymentKey.includes('nets')) {
                        paymentLabel = 'NETS QR';
                        paymentBadgeClass = paymentClassMap.nets;
                      } else if (paymentKey.includes('cash')) {
                        paymentLabel = 'COD';
                        paymentBadgeClass = paymentClassMap.cod;
                      } else if (rawPayment) {
                        paymentLabel = rawPayment;
                      }
                    %>
                    <span class="badge <%= paymentBadgeClass %>"><%= paymentLabel %></span>
                  </td>
                  <td><%= o.createdAt && o.createdAt.toLocaleString ? o.createdAt.toLocaleString() : o.createdAt %></td>
                  <td><%= o.totalQuantity %></td>
                  <td>$<%= Number(o.totalAmount).toFixed(2) %></td>
                  <td>
                    <span class="badge <%= badgeClass %>">
                      <%= status %>
                    </span>
                    <% if (statusLocked) { %>
                      <div class="text-muted small">Account deleted</div>
                    <% } %>
                  </td>
                  <td>
                    <form action="/admin/orders/<%= o.id %>/status" method="POST" class="d-flex gap-2 align-items-center">
                      <select name="status" class="form-select form-select-sm" <%= statusLocked ? 'disabled' : '' %>>
                        <% statuses.forEach(opt => { %>
                          <option value="<%= opt %>" <%= opt === status ? 'selected' : '' %>><%= opt %></option>
                        <% }) %>
                      </select>
                      <button type="submit" class="btn btn-sm btn-primary" <%= statusLocked ? 'disabled' : '' %>>Save</button>
                      <% if (statusLocked) { %>
                        <span class="text-muted small">Locked</span>
                      <% } %>
                    </form>
                  </td>
                  <td>
                    <a href="/admin/purchases/<%= o.id %>" class="btn btn-sm btn-outline-primary">View</a>
                  </td>
                </tr>
              <% }); %>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</body>
</html>
