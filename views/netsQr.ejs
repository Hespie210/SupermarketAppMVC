<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title><%= title %></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="/css/theme.css">
</head>
<body>
  <%- include('partials/header') %>

  <div class="container mt-4">
    <h2>NETS QR Payment</h2>
    <p class="text-muted mb-4">Scan the QR code with your banking app to pay.</p>

    <!-- QR + status panel -->
    <div class="row g-4 align-items-center">
      <div class="col-md-5 text-center">
        <img src="<%= qrCodeUrl %>" alt="NETS QR Code" class="img-fluid border rounded p-3 bg-white" style="max-width: 280px;">
      </div>
      <div class="col-md-7">
        <div class="section-card p-3">
          <p class="mb-2"><strong>Total:</strong> $<%= total %></p>
          <p class="mb-3"><strong>Response Code:</strong> <span id="netsResponseCode"><%= responseCode %></span></p>
          <% if (typeof txnRetrievalRef !== 'undefined' && txnRetrievalRef) { %>
            <p class="mb-3 text-muted"><strong>Transaction Ref:</strong> <%= txnRetrievalRef %></p>
          <% } %>
          <div id="netsStatus" class="alert alert-info mb-2">Waiting for payment confirmation...</div>
          <div id="netsError" class="alert alert-danger d-none"></div>
          <p class="text-muted mt-3 mb-0">This page will redirect automatically when payment is successful.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Poll NETS status and redirect on success -->
  <script>
    (function () {
      const statusBox = document.getElementById('netsStatus');
      const responseCodeEl = document.getElementById('netsResponseCode');
      const errorBox = document.getElementById('netsError');

      function showError(message) {
        errorBox.textContent = message;
        errorBox.classList.remove('d-none');
      }

      function pollStatus() {
        fetch('/nets-qr/status')
          .then(res => res.json())
          .then(data => {
            if (data && data.status === 'success' && data.orderId) {
              window.location.href = `/invoice/${data.orderId}`;
              return;
            }
            if (data && data.status === 'pending') {
              const code = data.responseCode || 'N.A.';
              responseCodeEl.textContent = code;
              statusBox.textContent = `Waiting for payment confirmation... (code: ${code})`;
              return;
            }
            throw new Error(data && data.error ? data.error : 'NETS payment failed.');
          })
          .catch(err => {
            showError(err.message || 'Unable to check NETS payment status.');
          });
      }

      const pollIntervalMs = 5000;
      setTimeout(() => {
        pollStatus();
        setInterval(pollStatus, pollIntervalMs);
      }, pollIntervalMs);
    })();
  </script>
</body>
</html>
