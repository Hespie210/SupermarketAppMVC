<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>All Receipts - Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="/css/theme.css">
</head>
<body>
  <%- include('partials/header') %>

  <div class="container mt-4">
    <!-- Page header + filters -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h2 class="mb-1">All Receipts</h2>
        <p class="text-muted mb-0">Orders across all customers</p>
      </div>
      <form class="d-flex gap-2" method="get" action="/admin/purchases">
        <input type="text" class="form-control form-control-sm" name="q" placeholder="Search user/email" value="<%= typeof q !== 'undefined' ? q : '' %>">
        <select name="status" class="form-select form-select-sm" style="max-width:150px;">
          <option value="">All statuses</option>
          <option value="Processing" <%= status === 'Processing' ? 'selected' : '' %>>Processing</option>
          <option value="Packing" <%= status === 'Packing' ? 'selected' : '' %>>Packing</option>
          <option value="Ready for Pickup" <%= status === 'Ready for Pickup' ? 'selected' : '' %>>Ready for Pickup</option>
          <option value="Out for Delivery" <%= status === 'Out for Delivery' ? 'selected' : '' %>>Out for Delivery</option>
          <option value="Completed" <%= status === 'Completed' ? 'selected' : '' %>>Completed</option>
          <option value="Cancelled" <%= status === 'Cancelled' ? 'selected' : '' %>>Cancelled</option>
          <option value="Failed Payment" <%= status === 'Failed Payment' ? 'selected' : '' %>>Failed Payment</option>
          <option value="Refund Requested" <%= status === 'Refund Requested' ? 'selected' : '' %>>Refund Requested</option>
          <option value="Refund Rejected" <%= status === 'Refund Rejected' ? 'selected' : '' %>>Refund Rejected</option>
          <option value="Refunded" <%= status === 'Refunded' ? 'selected' : '' %>>Refunded</option>
        </select>
        <button class="btn btn-primary btn-sm" type="submit">Filter</button>
      </form>
    </div>

<% if (!purchases || purchases.length === 0) { %>
  <p>No purchases have been made yet.</p>
<% } else { %>
<!-- Receipts table -->
<table class="table table-striped align-middle table-hover">
  <thead class="table-light">
    <tr>
      <th>Order #</th>
      <th>User</th>
      <th>Email</th>
      <th>Date/Time</th>
      <th>Payment</th>
      <th>Items</th>
      <th>Total</th>
      <th>Status</th>
      <th></th>
    </tr>
  </thead>

  <tbody>
    <% purchases.forEach(p => { 
      const statusClass = p.status === 'Completed' ? 'bg-success' :
                          p.status === 'Processing' ? 'bg-warning text-dark' :
                          p.status === 'Packing' || p.status === 'Out for Delivery' ? 'bg-info text-dark' :
                          p.status === 'Failed Payment' ? 'bg-danger' :
                          p.status === 'Refund Requested' ? 'bg-warning text-dark' :
                          p.status === 'Refund Rejected' ? 'bg-secondary' :
                          p.status === 'Refunded' ? 'bg-dark' : 'bg-secondary';
    %>
      <tr>
        <td class="fw-semibold">#<%= p.id %></td>
        <td><%= p.username %></td>
        <td class="text-muted small"><%= p.email %></td>
        <td>
          <%= p.createdAt && p.createdAt.toLocaleString
                ? p.createdAt.toLocaleString()
                : p.createdAt %>
        </td>
        <td><%= p.totalQuantity %></td>
        <td>
          <%
            const rawPayment = p.paymentMethod || '';
            const paymentKey = rawPayment.toLowerCase();
            let paymentLabel = 'N/A';
            let paymentBadgeClass = 'bg-secondary';
            if (paymentKey.includes('paypal')) {
              paymentLabel = 'PayPal';
              paymentBadgeClass = 'bg-primary';
            } else if (paymentKey.includes('stripe')) {
              paymentLabel = 'Stripe';
              paymentBadgeClass = 'bg-dark';
            } else if (paymentKey.includes('nets')) {
              paymentLabel = 'NETS QR';
              paymentBadgeClass = 'bg-info text-dark';
            } else if (paymentKey.includes('store credit')) {
              paymentLabel = 'Store Credit';
              paymentBadgeClass = 'bg-secondary';
            } else if (paymentKey.includes('cash')) {
              paymentLabel = 'COD';
              paymentBadgeClass = 'bg-secondary';
            } else if (rawPayment) {
              paymentLabel = rawPayment;
            }
          %>
          <span class="badge <%= paymentBadgeClass %>"><%= paymentLabel %></span>
        </td>
        <td>$<%= Number(p.totalAmount).toFixed(2) %></td>
        <td>
          <span class="badge <%= statusClass %>">
            <%= p.status || 'Processing' %>
          </span>
        </td>
        <td>
          <a 
            href="/admin/purchases/<%= p.id %>" 
            class="btn btn-sm btn-outline-primary"
          >
            View
          </a>
        </td>
      </tr>
    <% }) %>
  </tbody>
</table>
<% } %>

  </div>
</body>
</html>
