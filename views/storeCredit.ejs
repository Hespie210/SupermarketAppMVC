<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="/css/theme.css">
  <title>Store Credit</title>
</head>
<body>
  <%- include('partials/header') %>

  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h2 class="mb-1">Store Credit</h2>
        <p class="text-muted mb-0">
          Current balance: <strong id="storeCreditBalance">$<%= Number(storeCredit || 0).toFixed(2) %></strong>
        </p>
      </div>
    </div>

    <div class="section-card p-3">
      <h5 class="mb-3">Top Up with NETS QR</h5>

      <% if (errorMsg) { %>
        <div class="alert alert-danger"><%= errorMsg %></div>
      <% } %>
      <% if (successMsg) { %>
        <div class="alert alert-success"><%= successMsg %></div>
      <% } %>

      <form action="/store-credit/nets-qr" method="POST" class="row g-3 align-items-end">
        <div class="col-md-4">
          <label class="form-label">Amount (SGD)</label>
          <input type="number" name="amount" min="1" step="0.01" class="form-control" required>
        </div>
        <div class="col-md-4">
          <button class="btn btn-primary" type="submit">Generate NETS QR</button>
        </div>
      </form>
    </div>

    <% if (qrCodeUrl) { %>
      <div class="section-card p-3 mt-3">
        <h5 class="mb-3">Scan to Top Up</h5>
        <div class="row g-3 align-items-center">
          <div class="col-md-4 text-center">
            <img src="<%= qrCodeUrl %>" alt="NETS QR Code" class="img-fluid border rounded p-3 bg-white" style="max-width: 260px;">
          </div>
          <div class="col-md-8">
            <p class="mb-2"><strong>Amount:</strong> $<%= Number(amount || 0).toFixed(2) %></p>
            <p class="mb-2"><strong>Response Code:</strong> <span id="netsResponseCode"><%= responseCode || 'PENDING' %></span></p>
            <div id="netsStatus" class="alert alert-info mb-2">Waiting for payment confirmation...</div>
            <div id="netsError" class="alert alert-danger d-none"></div>
          </div>
        </div>
      </div>
    <% } %>

    <div class="section-card p-3 mt-3">
      <h5 class="mb-3">Store Credit History</h5>
      <% if (!history || history.length === 0) { %>
        <p class="text-muted mb-0">No top-ups yet.</p>
      <% } else { %>
        <div class="table-responsive">
          <table class="table table-striped align-middle mb-0">
            <thead>
              <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Amount</th>
                <th>Reference</th>
              </tr>
            </thead>
            <tbody>
              <% history.forEach(item => { %>
                <tr>
                  <td>
                    <%= item.createdAt && item.createdAt.toLocaleString
                          ? item.createdAt.toLocaleString()
                          : item.createdAt %>
                  </td>
                  <td class="text-capitalize"><%= item.type || 'topup' %></td>
                  <td>$<%= Number(item.amount || 0).toFixed(2) %></td>
                  <td><%= item.reference || '-' %></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      <% } %>
    </div>
  </div>

  <% if (qrCodeUrl) { %>
  <script>
    (function () {
      const statusBox = document.getElementById('netsStatus');
      const responseCodeEl = document.getElementById('netsResponseCode');
      const errorBox = document.getElementById('netsError');
      const balanceEl = document.getElementById('storeCreditBalance');
      const navBalanceEl = document.getElementById('storeCreditNavAmount');

      function showError(message) {
        if (!errorBox) return;
        errorBox.textContent = message;
        errorBox.classList.remove('d-none');
      }

      function setStatus(message, type) {
        if (!statusBox) return;
        statusBox.textContent = message;
        statusBox.className = `alert alert-${type} mb-2`;
      }

      const timer = setInterval(() => {
        fetch('/store-credit/nets-qr/status')
          .then(res => res.json())
          .then(data => {
            if (data && data.responseCode && responseCodeEl) {
              responseCodeEl.textContent = data.responseCode;
            }
            if (data && data.status === 'success') {
              setStatus('Top-up completed. Store credit updated.', 'success');
              if (balanceEl && typeof data.balance !== 'undefined') {
                const formatted = Number(data.balance || 0).toFixed(2);
                balanceEl.textContent = `$${formatted}`;
                if (navBalanceEl) {
                  navBalanceEl.textContent = `$${formatted}`;
                }
              }
              clearInterval(timer);
              return;
            }
            if (data && data.status === 'failed') {
              setStatus('Top-up failed.', 'danger');
              showError(data.error || 'NETS payment failed.');
              clearInterval(timer);
              return;
            }
            setStatus('Waiting for payment confirmation...', 'info');
          })
          .catch(() => {
            showError('Unable to check NETS payment status.');
          });
      }, 3000);
    })();
  </script>
  <% } %>
</body>
</html>
